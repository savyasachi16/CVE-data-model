import requests
import zipfile
import os
from config import FEED_BASE_URL,FEED_MODIFIED_URL,FEED_RECENT_URL

class Download:
    def __init__(self):
        self.FEED_BASE_URL = FEED_BASE_URL
        self.FEED_RECENT_URL = FEED_MODIFIED_URL
        self.FEED_MODIFIED_URL = FEED_RECENT_URL
        self.FEED_URLS = []

        for x in range(2002, 2021):
            var = self.FEED_BASE_URL+str(x)+".json.zip"
            self.FEED_URLS.append(var)

    def downloadZip(self, url):
        print("Downloading zip...")
        file = requests.get(url)
        filepath = "./rawdata/"+url[-13:]
        print(url + " Download Complete...")
        open(filepath, 'wb').write(file.content)
        return filepath

    def extractZip(self, filepath):
        print("Extracting zip..")
        with zipfile.ZipFile(filepath, 'r') as zip_ref:
            zip_ref.extractall("./rawdata/")
        print("JSON Extraction Complete...")

    def deleteZip(self, filepath):
        print("Deleting zip...")
        if os.path.exists(filepath):
            os.remove(filepath)
        print("Deleted zip file...")

    def downloadBaseFeed(self):
        for x in self.FEED_URLS:
            filepath = self.downloadZip(x)
            self.extractZip(filepath)
            self.deleteZip(filepath)

    def downloadRecentFeed(self):
        filepath = self.downloadZip(self.FEED_RECENT_URL)
        self.extractZip(filepath)
        self.deleteZip(filepath)

    def downloadModifiedFeed(self):
        filepath = self.downloadZip(self.FEED_MODIFIED_URL)
        self.extractZip(filepath)
        self.deleteZip(filepath)

    def downloadAll(self):
        self.downloadBaseFeed()
        self.downloadModifiedFeed()
        self.downloadRecentFeed()
